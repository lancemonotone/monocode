(function(){angular.module("wmsDining").controller("MenuCtrl",a);a.$inject=["MenuService","$filter","includedServiceUnits","excludedCourses","translatedCourses","translatedServiceUnits","$location","$log","debug"];function a(y,t,z,c,b,v,h,u,r){var e=this;e.errorMsg="";e.fetchingData=true;e.filteredMeals={};e.status="";e.serviceUnits=[];e.selectedServiceUnit={};e.meals=[];e.mealList=[];e.selectedMeal=null;e.parseURL=m;e.init=x;e.getServiceUnits=j;e.getMealsByServiceUnit=g;e.includeServiceUnits=A;e.translateAndExcludeCourses=l;e.translateServiceUnits=k;e.buildMealList=C;e.initMealList=B;e.getMenuByMeal=D;e.preloadServiceUnit=E;e.preloadMeal=q;e.isServiceUnitSelected=F;e.isMealSelected=d;e.setSelectedServiceUnit=f;e.setSelectedMeal=s;e.showFullMenuLink=o;e.showBookmarkLink=p;e.showMeals=w;e.showMealList=i;e.init();function x(){e.getServiceUnits();e.parseURL()}function m(){var G=window.location.href;var I=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?");var H=G.match(I);e.thisURL={scheme:H[2],authority:H[4],path:H[5],query:H[7],fragment:H[9]}}function w(){return Object.keys(e.mealList).length&&!e.fetchingData}function i(){return Object.keys(e.filteredMeals).length&&!e.fetchingData}function o(){return Object.keys(e.filteredMeals).length&&e.selectedMeal&&e.selectedServiceUnit.net_nutrition}function p(){return Object.keys(e.filteredMeals).length&&e.selectedMeal&&e.selectedServiceUnit}function F(G){return e.selectedServiceUnit.unitid===G}function d(G){return e.selectedMeal===G}function j(){y.request(y.url("serviceUnits")).success(function(H,G){e.serviceUnits=e.includeServiceUnits(H);e.fetchingData=false;e.preloadServiceUnit();e.preloadMeal()}).error(function(I,G,J,H){e.errorMsg="Request failed: Unable to load facilities: "+G;e.fetchingData=false})}function f(G){e.selectedServiceUnit=_.findWhere(e.serviceUnits,{unitid:G})}function E(){var G=h.search()["unitid"]||null;if(G){e.getMealsByServiceUnit(G)}}function k(G){G=_.each(G,function(H){if(H.service_unit in v){H.service_unit=v[H.service_unit]}});return G}function A(G){G=_.filter(G,function(H){return z.indexOf(H.service_unit)>-1});return e.translateServiceUnits(G)}function q(){e.setSelectedMeal(h.search()["meal"]||null)}function g(G){if(G===e.selectedServiceUnit.unitid){return false}e.fetchingData=true;if(G!==null){e.setSelectedServiceUnit(G);y.request(y.url("serviceUnits",G)).success(function(I,H){e.meals=e.translateAndExcludeCourses(I);e.buildMealList();e.getMenuByMeal();e.fetchingData=false}).error(function(J,H,K,I){e.errorMsg="Request failed: Unable to load menus: "+H;e.fetchingData=false})}else{e.meals=[];e.mealList=[];e.fetchingData=false}}function s(G){e.selectedMeal=G||null}function C(){e.mealList=[];_.each(e.meals,function(G){if(e.mealList.indexOf(G.meal)===-1){e.mealList.push(G.meal)}})}function l(G){_.each(G,function(H){if(H.course in b){H.course=b[H.course]}});return _.reject(G,function(H){return c.indexOf(H.course)>-1})}function B(){if(e.selectedMeal===null){if(e.mealList.indexOf(e.selectedMeal)===-1){e.setSelectedMeal(null)}if(e.mealList.length===1){e.setSelectedMeal(e.mealList[0])}}}function D(H){H=H||e.selectedMeal;e.setSelectedMeal(H);e.initMealList();e.filteredMeals={};if(e.selectedMeal){var G=t("filter")(e.meals,{meal:e.selectedMeal});if(G.length>0){e.filteredMeals=_.groupBy(G,"course")}}}function n(J,H,I){for(var G=0;G<J.length;G++){if(J[G][H]===I){return G}}return -1}}})();